<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>実習評価システム</title>
    <style>
        /* 全体の余計な余白を完全にリセット */
        * { box-sizing: border-box; }
        html, body { margin: 0; padding: 0; width: 100%; height: 100%; background-color: #f0f2f5; overflow-x: hidden; }

        /* 画面切り替え： activeでない方は物理的に消去 */
        .screen { display: none; width: 100%; }
        
        /* 1. ログイン画面：中央配置 */
        #loginScreen.active { 
            display: flex; 
            height: 100vh; 
            align-items: center; 
            justify-content: center; 
            background-color: #dee2e6; 
        }
        .login-card { 
            background: white; 
            padding: 30px; 
            border-radius: 12px; 
            box-shadow: 0 4px 20px rgba(0,0,0,0.1); 
            width: 320px; 
        }

        /* 2. 評価画面：ボタンの下に何も残さない */
        #mainApp.active { display: block; padding: 0; }
        .app-container { max-width: 800px; margin: 0 auto; padding: 20px 15px; }
        
        /* 各セクションのカード */
        .card { 
            background: white; 
            padding: 20px; 
            margin-bottom: 20px; 
            border-radius: 10px; 
            box-shadow: 0 1px 3px rgba(0,0,0,0.1); 
        }

        /* フォーム部品 */
        .form-control { width: 100%; padding: 10px; font-size: 16px; border: 1px solid #ccc; border-radius: 6px; margin-top: 5px; }
        h2 { font-size: 1.1rem; color: #1a73e8; border-left: 5px solid #1a73e8; padding-left: 10px; margin: 0 0 15px 0; }
        .eval-row { display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom: 1px solid #eee; }
        .radio-group { display: flex; gap: 8px; }
        .btn { padding: 12px 24px; cursor: pointer; border-radius: 6px; font-weight: bold; border: none; font-size: 16px; }
        .btn--primary { background: #1a73e8; color: white; width: 100%; }
        
        /* 保存ボタン：マージンを最小限にして、これより下に余白を作らない */
        .btn--save { 
            background: #28a745; 
            color: white; 
            width: 100%; 
            font-size: 1.2rem; 
            padding: 18px; 
            margin: 10px 0 0 0; 
        }

        .btn--logout { background: #6c757d; color: white; padding: 6px 12px; font-size: 14px; }
        .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .grid-att { display: grid; grid-template-columns: repeat(auto-fit, minmax(100px, 1fr)); gap: 10px; }
        label { font-size: 14px; font-weight: bold; }
        p { margin: 0; }
    </style>
</head>
<body>

    <div id="loginScreen" class="screen active">
        <div class="login-card">
            <h1 style="text-align:center; font-size: 1.2rem; margin:0 0 20px 0;">ログイン</h1>
            <form id="loginForm">
                <div style="margin-bottom:15px;"><label>学籍番号</label><input type="text" id="studentId" class="form-control" required></div>
                <div style="margin-bottom:20px;"><label>パスワード</label><input type="password" id="password" class="form-control" required></div>
                <button type="submit" class="btn btn--primary" id="loginBtn">ログイン</button>
                <div id="loginError" style="color:red; text-align:center; font-size:13px; margin-top:10px; min-height:1em;"></div>
            </form>
        </div>
    </div>

    <div id="mainApp" class="screen">
        <div class="app-container">
            <header style="display:flex; justify-content: space-between; align-items: center; background:white; padding:12px 15px; border-radius:8px; margin-bottom:20px; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
                <div style="font-size:14px; line-height:1.4;">ID: <span id="displayId"></span><br><strong><span id="currentUserName"></span> 様</strong></div>
                <button onclick="location.reload()" class="btn btn--logout">ログアウト</button>
            </header>

            <form id="evaluationForm">
                <section class="card">
                    <h2>施設・機関情報</h2>
                    <div class="grid-2">
                        <div><label>種別</label><input type="text" id="info_type" class="form-control"></div>
                        <div><label>設置主体名</label><input type="text" id="info_owner" class="form-control"></div>
                    </div>
                    <div style="margin-top:10px;"><label>施設・機関名</label><input type="text" id="info_facility" class="form-control"></div>
                    <div style="margin-top:10px;"><label>所在地</label><input type="text" id="info_address" class="form-control"></div>
                    <div class="grid-2" style="margin-top:10px;">
                        <div><label>代表者</label><input type="text" id="info_rep" class="form-control"></div>
                        <div><label>指導者</label><input type="text" id="info_mentor" class="form-control"></div>
                    </div>
                </section>

                <section class="card">
                    <h2>出席状況</h2>
                    <div class="grid-2" style="margin-bottom:15px;">
                        <div><label>開始日</label><input type="date" id="date_start" class="form-control"></div>
                        <div><label>終了日</label><input type="date" id="date_end" class="form-control"></div>
                    </div>
                    <div style="margin-bottom:15px;">
                        <label>通い・宿泊：</label>
                        <input type="radio" name="stay_type" value="通い" id="stay_1"> <label for="stay_1" style="font-weight:normal;">通い</label>
                        <input type="radio" name="stay_type" value="宿泊" id="stay_2" style="margin-left:15px;"> <label for="stay_2" style="font-weight:normal;">宿泊</label>
                    </div>
                    <div class="grid-att">
                        <div><label style="font-size:11px;">出席すべき日数</label><input type="number" id="att_must" class="form-control"></div>
                        <div><label style="font-size:11px;">出席日数</label><input type="number" id="att_done" class="form-control"></div>
                        <div><label style="font-size:11px;">欠席</label><input type="number" id="att_absent" class="form-control"></div>
                        <div><label style="font-size:11px;">遅刻</label><input type="number" id="att_late" class="form-control"></div>
                        <div><label style="font-size:11px;">早退</label><input type="number" id="att_early" class="form-control"></div>
                    </div>
                </section>

                <div id="dynamicSections"></div>

                <section class="card">
                    <h2>Ｅ 総合評価</h2>
                    <div class="radio-group" id="group-E" style="justify-content: space-around;"></div>
                </section>

                <section class="card">
                    <h2>所見・アドバイス</h2>
                    <div style="margin-bottom:15px;"><label>Ｆ 総評</label><textarea id="comment-F" class="form-control" rows="4"></textarea></div>
                    <div><label>Ｇ アドバイス</label><textarea id="comment-G" class="form-control" rows="4"></textarea></div>
                </section>

                <button type="submit" class="btn btn--save" id="saveBtn">保存・更新する</button>
            </form>
        </div>
    </div>

    <script>
        const GAS_URL = "https://script.google.com/macros/s/AKfycbzBuU4I8fuECSldym_-c2KDY8gVFGCwAIyjZdMqWr5nH88u9xiqgBbU71ylaA56GQyy8A/exec";
        const evalConfig = {
            'A': ['生活課題・ニーズの理解', '職種の業務内容の理解', '施設・機関の機構の理解', '関連施設・制度の理解'],
            'B': ['共感的・理解的な態度', '基本的技術の習得', '実習日誌の作成能力'],
            'C': ['規則の遵守・マナー', '習得への意欲', '利用者への関わり', '人権・人格の尊重', '指導を求める態度', '他職種との協働'],
            'D': ['実習目標達成度', '援助関係の深化', '実践現場の理解', '実践技術の向上', '自己理解の深化']
        };

        function makeRadios(name) {
            return [5, 4, 3, 2, 1, '非該当'].map(v => `<label style="font-size:11px; text-align:center;"><input type="radio" name="${name}" value="${v}"><br>${v}</label>`).join('');
        }

        function initForm() {
            let html = '';
            for (let key in evalConfig) {
                html += `<section class="card"><h2>${key}項目</h2>`;
                evalConfig[key].forEach((text, i) => {
                    html += `<div class="eval-row"><div style="font-size:13px; flex:1;">${text}</div><div class="radio-group">${makeRadios(key+(i+1))}</div></div>`;
                });
                html += `<p style="margin-top:12px; font-weight:bold; font-size:13px;">【${key} 所見】</p><textarea id="view-${key}" class="form-control" rows="3"></textarea></section>`;
            }
            document.getElementById('dynamicSections').innerHTML = html;
            document.getElementById('group-E').innerHTML = makeRadios('E');
        }

        async function postData(payload) {
            const response = await fetch(GAS_URL, { method: "POST", body: JSON.stringify(payload) });
            return await response.json();
        }

        document.getElementById('loginForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const btn = document.getElementById('loginBtn');
            const err = document.getElementById('loginError');
            btn.disabled = true; btn.innerText = "認証中...";
            try {
                const result = await postData({
                    action: "login",
                    studentId: document.getElementById('studentId').value,
                    password: document.getElementById('password').value
                });
                if (result.success) {
                    document.getElementById('displayId').innerText = result.id;
                    document.getElementById('currentUserName').innerText = result.userName;
                    if (result.savedData) fillForm(result.savedData);
                    document.getElementById('loginScreen').classList.remove('active');
                    document.getElementById('mainApp').classList.add('active');
                    window.scrollTo(0,0);
                } else { err.innerText = "認証失敗"; }
            } catch(e) { err.innerText = "通信エラー"; }
            btn.disabled = false; btn.innerText = "ログイン";
        });

        function fillForm(d) {
            const setVal = (id, val) => { const el = document.getElementById(id); if(el) el.value = val || ""; };
            setVal('info_type', d[3]); setVal('info_owner', d[4]); setVal('info_facility', d[5]);
            setVal('info_address', d[6]); setVal('info_rep', d[7]); setVal('info_mentor', d[8]);
            setVal('date_start', d[9]); setVal('date_end', d[10]);
            if(d[11]) { const r = document.querySelector(`input[name="stay_type"][value="${d[11]}"]`); if(r) r.checked = true; }
            setVal('att_must', d[12]); setVal('att_done', d[13]); setVal('att_absent', d[14]);
            setVal('att_late', d[15]); setVal('att_early', d[16]);
            let col = 18;
            for (let key in evalConfig) {
                evalConfig[key].forEach((_, i) => {
                    const r = document.querySelector(`input[name="${key}${i+1}"][value="${d[col++]}"]`);
                    if(r) r.checked = true;
                });
                setVal(`view-${key}`, d[col++]);
            }
            const rE = document.querySelector(`input[name="E"][value="${d[col++]}"]`); if(rE) rE.checked = true;
            setVal('comment-F', d[col++]); setVal('comment-G', d[col++]);
        }

        document.getElementById('evaluationForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const btn = document.getElementById('saveBtn');
            btn.disabled = true; btn.innerText = "保存中...";
            const formData = [
                document.getElementById('displayId').innerText,
                document.getElementById('currentUserName').innerText,
                "ソーシャルワーク実習",
                document.getElementById('info_type').value, document.getElementById('info_owner').value,
                document.getElementById('info_facility').value, document.getElementById('info_address').value,
                document.getElementById('info_rep').value, document.getElementById('info_mentor').value,
                document.getElementById('date_start').value, document.getElementById('date_end').value,
                (document.querySelector('input[name="stay_type"]:checked') || {}).value || "",
                document.getElementById('att_must').value, document.getElementById('att_done').value,
                document.getElementById('att_absent').value, document.getElementById('att_late').value,
                document.getElementById('att_early').value, ""
            ];
            for (let key in evalConfig) {
                evalConfig[key].forEach((_, i) => {
                    formData.push((document.querySelector(`input[name="${key}${i+1}"]:checked`) || {}).value || "");
                });
                formData.push(document.getElementById(`view-${key}`).value);
            }
            formData.push((document.querySelector('input[name="E"]:checked') || {}).value || "");
            formData.push(document.getElementById('comment-F').value);
            formData.push(document.getElementById('comment-G').value);
            try { await postData({ action: "save", formData }); alert("保存完了"); } catch(e) { alert("エラー"); }
            btn.disabled = false; btn.innerText = "保存・更新する";
        });
        initForm();
    </script>
</body>
</html>
