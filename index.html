<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma@0.9.4/css/bulma.min.css">
  <style>
    .section-title { background: #f4f4f4; padding: 10px; font-weight: bold; border-left: 5px solid #3273dc; margin-top: 20px; }
    .radio-group { display: flex; gap: 10px; }
    @media print { .no-print { display: none; } .container { width: 100%; } }
  </style>
</head>
<body>
  <div id="app" class="container p-5">
    <div id="login-form" class="box" style="max-width: 400px; margin: auto;">
      <h1 class="title is-4">実習評価システム ログイン</h1>
      <div class="field">
        <label class="label">学籍番号</label>
        <input class="input" type="text" id="user-id">
      </div>
      <div class="field">
        <label class="label">パスワード</label>
        <input class="input" type="password" id="user-pass">
      </div>
      <button class="button is-link is-fullwidth" onclick="doLogin()">ログイン</button>
    </div>

    <div id="main-content" style="display:none;">
      <div class="level no-print">
        <div class="level-left"><h1 class="title">ソーシャルワーク実習 成績評価表</h1></div>
        <div class="level-right">
          <button class="button is-success mr-2" onclick="submitForm()">保存/更新</button>
          <button class="button is-info" onclick="window.print()">印刷</button>
        </div>
      </div>

      <div class="box">
        <div class="columns is-multiline">
          <div class="column is-3"><strong>大学名:</strong> 種智院大学</div>
          <div class="column is-3"><strong>学籍番号:</strong> <span id="display-id"></span></div>
          <div class="column is-3"><strong>氏名:</strong> <span id="display-name"></span></div>
          <div class="column is-3"><strong>科目名:</strong> ソーシャルワーク実習</div>
        </div>
      </div>

      <div class="section-title">Ａ 基本的知識の理解・習得の状況</div>
      <table class="table is-fullwidth">
        <thead><tr><th>評価項目</th><th>評価 (5=良, 1=要努力)</th></tr></thead>
        <tbody id="table-A">
          </tbody>
      </table>
      <label class="label">【A 所見】</label>
      <textarea class="textarea mb-4" id="view-A"></textarea>

      <div id="dynamic-sections"></div>

      <div class="section-title">Ｅ 総合評価</div>
      <div class="radio-group p-3" id="group-E"></div>

      <div class="section-title">Ｆ 実習生に関する総評</div>
      <textarea class="textarea mb-4" id="view-F" rows="5"></textarea>

      <div class="section-title">Ｇ アドバイス</div>
      <textarea class="textarea mb-4" id="view-G" rows="5"></textarea>
    </div>
  </div>

  <script>
    const config = {
      'A': ['利用者及び生活課題の理解', '職種の業務内容の理解', '施設・機関の機構・機能の理解', '他施設・社会資源の理解'],
      'B': ['利用者への共感的態度', '基本的技術の習得', '実習日誌・記録の作成能力'],
      'C': ['規則の遵守・マナー', '習得への意欲・積極性', '利用者への関わり', '人権・人格の尊重', '指導を求める態度', '他職種との協働'],
      'D': ['各自の実習目標達成度', '援助関係の深化', '実践現場の理解深化', '実践技術の向上', '自己理解の深化']
    };

    function initForm() {
      for (let s in config) {
        let html = '';
        config[s].forEach((item, i) => {
          html += `<tr><td>${item}</td><td>${generateRadios(s + (i+1))}</td></tr>`;
        });
        if(s === 'A') document.getElementById('table-A').innerHTML = html;
        else {
          document.getElementById('dynamic-sections').innerHTML += `
            <div class="section-title">${s}項目</div>
            <table class="table is-fullwidth"><tbody>${html}</tbody></table>
            <label class="label">【${s} 所見】</label><textarea class="textarea mb-4" id="view-${s}"></textarea>
          `;
        }
      }
      document.getElementById('group-E').innerHTML = generateRadios('E');
    }

    function generateRadios(name) {
      return [5,4,3,2,1,'非該当'].map(v => 
        `<label class="radio"><input type="radio" name="${name}" value="${v}"> ${v}</label>`
      ).join(' ');
    }

    function doLogin() {
      const id = document.getElementById('user-id').value;
      const pass = document.getElementById('user-pass').value;
      google.script.run.withSuccessHandler(res => {
        if(res.success) {
          document.getElementById('login-form').style.display = 'none';
          document.getElementById('main-content').style.display = 'block';
          document.getElementById('display-id').innerText = res.user.id;
          document.getElementById('display-name').innerText = res.user.name;
          if(res.savedData) fillForm(res.savedData);
        } else { alert('ログイン失敗'); }
      }).login(id, pass);
    }

    function fillForm(data) {
      // 保存済みデータをフォームに反映するロジック（インデックスに合わせてセット）
      // ...省略（実装の簡略化のため）
    }

    function submitForm() {
      const id = document.getElementById('display-id').innerText;
      const name = document.getElementById('display-name').innerText;
      let results = [id, name, "ソーシャルワーク実習", "実習施設名"];
      
      // ラジオボタンとテキストエリアから値を収集して配列に格納
      // サーバー側の saveData(results) を呼び出す
      google.script.run.withSuccessHandler(msg => alert(msg)).saveData(results);
    }

    initForm();
  </script>
</body>
</html>
