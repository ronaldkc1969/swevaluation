<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>実習評価システム</title>
    <style>
        * { box-sizing: border-box; }
        html, body { margin: 0; padding: 0; width: 100%; height: 100%; background-color: #f0f2f5; font-family: sans-serif; }
        .screen { display: none; width: 100%; }
        
        /* ログイン画面 */
        #loginScreen.active { display: flex; height: 100vh; align-items: center; justify-content: center; background-color: #dee2e6; }
        .login-card { background: white; padding: 30px; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.1); width: 320px; }
        
        /* 評価画面 */
        #mainApp.active { display: block; }
        .app-container { max-width: 800px; margin: 0 auto; padding: 20px 15px; }
        .card { background: white; padding: 20px; margin-bottom: 20px; border-radius: 10px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        .form-control { width: 100%; padding: 10px; font-size: 16px; border: 1px solid #ccc; border-radius: 6px; margin-top: 5px; }
        h2 { font-size: 1.1rem; color: #1a73e8; border-left: 5px solid #1a73e8; padding-left: 10px; margin: 0 0 15px 0; }
        .eval-row { display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom: 1px solid #eee; }
        .radio-group { display: flex; gap: 8px; }
        .btn { padding: 12px 24px; cursor: pointer; border-radius: 6px; font-weight: bold; border: none; font-size: 16px; }
        .btn--primary { background: #1a73e8; color: white; width: 100%; }
        .btn--save { background: #28a745; color: white; width: 100%; font-size: 1.2rem; padding: 18px; margin: 10px 0 0 0; }
        .btn--logout { background: #6c757d; color: white; padding: 6px 12px; font-size: 14px; }
        .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        label { font-size: 14px; font-weight: bold; }
    </style>
</head>
<body>

    <div id="loginScreen" class="screen active">
        <div class="login-card">
            <h2 style="text-align:center; border:none; padding:0; color:#333;">ログイン</h2>
            <form id="loginForm">
                <div style="margin-bottom:15px;"><label>学籍番号</label><input type="text" id="studentId" class="form-control" required></div>
                <div style="margin-bottom:20px;"><label>パスワード</label><input type="password" id="password" class="form-control" required></div>
                <button type="submit" class="btn btn--primary" id="loginBtn">ログイン</button>
                <div id="loginError" style="color:red; text-align:center; font-size:13px; margin-top:10px;"></div>
            </form>
        </div>
    </div>

    <div id="mainApp" class="screen">
        <div class="app-container">
            <header style="display:flex; justify-content: space-between; align-items: center; background:white; padding:12px 15px; border-radius:8px; margin-bottom:20px;">
                <div style="font-size:14px;">学籍番号: <span id="displayId"></span><br><strong><span id="currentUserName"></span> 様</strong></div>
                <button onclick="location.reload()" class="btn btn--logout">ログアウト</button>
            </header>

            <form id="evaluationForm">
                <section class="card">
                    <h2>施設・機関情報</h2>
                    <div class="grid-2">
                        <div><label>種別</label><input type="text" id="info_type" class="form-control"></div>
                        <div><label>設置主体名</label><input type="text" id="info_owner" class="form-control"></div>
                    </div>
                    <div style="margin-top:10px;"><label>施設・機関名</label><input type="text" id="info_facility" class="form-control"></div>
                    <div class="grid-2" style="margin-top:10px;">
                        <div><label>代表者</label><input type="text" id="info_rep" class="form-control"></div>
                        <div><label>指導者</label><input type="text" id="info_mentor" class="form-control"></div>
                    </div>
                </section>

                <div id="dynamicSections"></div>

                <section class="card">
                    <h2>Ｅ 総合評価</h2>
                    <div class="radio-group" id="group-E" style="justify-content: space-around;"></div>
                </section>

                <section class="card" style="margin-bottom: 0;">
                    <h2>所見・アドバイス</h2>
                    <div style="margin-bottom:15px;"><label>Ｆ 総評</label><textarea id="comment-F" class="form-control" rows="4"></textarea></div>
                    <div><label>Ｇ アドバイス</label><textarea id="comment-G" class="form-control" rows="4"></textarea></div>
                </section>

                <button type="submit" class="btn btn--save" id="saveBtn">データを保存・更新する</button>
            </form>
        </div>
    </div>

    <script>
        const GAS_URL = "https://script.google.com/macros/s/AKfycbya4EWDso0PyWyc8bwKJdoITBLHqS6b5Kk4yR1EuUBhgtP0FA1NLb8uefOncngVhUjiJQ/exec";
        
        const evalConfig = {
            'A': ['生活課題の理解', '職種の業務理解', '施設機構の理解'],
            'B': ['共感的態度', '基本的技術', '日誌作成能力'],
            'C': ['マナー', '意欲', '人権尊重', '指導を求める態度'],
            'D': ['目標達成度', '援助関係', '自己理解']
        };

        function initForm() {
            let html = '';
            for (let key in evalConfig) {
                html += `<section class="card"><h2>${key}項目</h2>`;
                evalConfig[key].forEach((text, i) => {
                    html += `<div class="eval-row"><div style="font-size:13px; flex:1;">${text}</div><div class="radio-group">` + 
                            [5,4,3,2,1,'非該当'].map(v => `<label style="font-size:11px; text-align:center;"><input type="radio" name="${key}${i+1}" value="${v}"><br>${v}</label>`).join('') + 
                            `</div></div>`;
                });
                html += `<p style="margin-top:12px; font-weight:bold; font-size:13px;">【${key} 所見】</p><textarea id="view-${key}" class="form-control" rows="3"></textarea></section>`;
            }
            document.getElementById('dynamicSections').innerHTML = html;
            document.getElementById('group-E').innerHTML = [5,4,3,2,1,'非該当'].map(v => `<label style="font-size:11px; text-align:center;"><input type="radio" name="E" value="${v}"><br>${v}</label>`).join('');
        }

        async function postGAS(payload) {
            const res = await fetch(GAS_URL, { method: "POST", body: JSON.stringify(payload) });
            return await res.json();
        }

        document.getElementById('loginForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const err = document.getElementById('loginError');
            err.innerText = "認証中...";
            try {
                const res = await postGAS({ action: "login", studentId: document.getElementById('studentId').value, password: document.getElementById('password').value });
                if (res.success) {
                    document.getElementById('displayId').innerText = res.id;
                    document.getElementById('currentUserName').innerText = res.userName;
                    if (res.savedData) fillForm(res.savedData);
                    document.getElementById('loginScreen').classList.remove('active');
                    document.getElementById('mainApp').classList.add('active');
                } else { err.innerText = "IDまたはパスワードが違います"; }
            } catch(e) { err.innerText = "通信エラー"; }
        });

        function fillForm(d) {
            const setVal = (id, val) => { if(document.getElementById(id)) document.getElementById(id).value = val || ""; };
            setVal('info_type', d[3]); setVal('info_owner', d[4]); setVal('info_facility', d[5]);
            setVal('info_rep', d[7]); setVal('info_mentor', d[8]);
            
            let col = 18;
            for (let key in evalConfig) {
                evalConfig[key].forEach((_, i) => {
                    const r = document.querySelector(`input[name="${key}${i+1}"][value="${d[col++]}"]`);
                    if(r) r.checked = true;
                });
                setVal(`view-${key}`, d[col++]);
            }
            const rE = document.querySelector(`input[name="E"][value="${d[col++]}"]`);
            if(rE) rE.checked = true;
            setVal('comment-F', d[col++]); setVal('comment-G', d[col++]);
        }

        document.getElementById('evaluationForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const btn = document.getElementById('saveBtn');
            btn.disabled = true; btn.innerText = "保存中...";
            
            const formData = [
                document.getElementById('displayId').innerText,
                document.getElementById('currentUserName').innerText,
                "実習評価",
                document.getElementById('info_type').value, document.getElementById('info_owner').value,
                document.getElementById('info_facility').value, "",
                document.getElementById('info_rep').value, document.getElementById('info_mentor').value,
                "","","", "","","","","","" 
            ];
            
            for (let key in evalConfig) {
                evalConfig[key].forEach((_, i) => {
                    formData.push((document.querySelector(`input[name="${key}${i+1}"]:checked`) || {}).value || "");
                });
                formData.push(document.getElementById(`view-${key}`).value);
            }
            formData.push((document.querySelector('input[name="E"]:checked') || {}).value || "");
            formData.push(document.getElementById('comment-F').value);
            formData.push(document.getElementById('comment-G').value);

            try {
                await postGAS({ action: "save", formData });
                alert("上書き保存が完了しました");
            } catch(e) { alert("保存エラー"); }
            btn.disabled = false; btn.innerText = "データを保存・更新する";
        });

        initForm();
    </script>
</body>
</html>
